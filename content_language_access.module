<?php

/**
 * @file
 *
 * This module provides access checking for the current language of the site with the
 * language of the content (language neutral are not considered).
 */

/**
 * Implementation of hook_menu_alter().
 */
function content_language_access_menu_alter(&$callbacks) {
  // Use _content_language_access_node_access() instead of node_access().
  // TODO check if this is not overrriding any other access callback
  $callbacks['node/%node']['access callback'] = '_content_language_access_node_access';

}

/**
 * Wrapper around node_access() with additional checks for language permissions.
 *
 * @see node_access()
 */
function _content_language_access_node_access($op, $node, $account = NULL) {
  global $user;
  global $language;

  // If no user object is supplied, the access check is for the current user.
  if (empty($account)) {
    $account = $user;
  }
  // Convert the node to an object if necessary:
  if ($op != 'create') {
    $node = (object)$node;
  }

  $access = node_access($op, $node, $account);

  // Bypass completely if access returns false.
  if (!$access) {
    return FALSE;
  }

  // Only checks for view permission
  if ($op != 'view') {
    return TRUE;
  }

  // Language neutral are always allowed
  if ($node->language) {
    // Verifies if the current language is the same of the content
    if ($node->language == $language->language) {
      return TRUE;
    }
  }
  else {
    // Language neutral are always allowed
    return TRUE;
  }

  return FALSE;
}
